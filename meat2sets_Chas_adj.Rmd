---
title: "Meat to Chastity Adjusted (Irina) DEGs SEGs from NPSB"
output: html_notebook
---

libraries
```{r}
library(reshape2)
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(tidyr)
library(ggpubr)
#library("readxl")
library(datasets)  
library(purrr)
```

- get new PSB raw data, filtered and modified
```{r}

param3='Christel NPSB'

source("new_PSB.R")
main_raw <-new_PSB(param3)
dim (main_raw)->size_mr
size_mr

#read_tsv("C:/Users/ia1/Documents/R_work/Ect_Mes_DEG/E7_5_pseudobulk_log2CPM_200331.txt", col_types = cols(Chromosome = col_character())) -> expressionRaw
#expressionRaw

```

#- Given raw  gene data(expressionRaw): filter it and modify main_raw

```{r}

#--------------------filter new pseudobulk

#expressionRaw %>% 
#  filter(Chromosome != "ERCC" & Chromosome != "MT" & Chromosome != "Y") %>% 
#  select(Probe, Chromosome, Start, End, `Probe Strand`, #Ectoderm_counts, Endoderm_counts, 'Mesoderm counts') %>% 
#  distinct(Probe, .keep_all = T) %>% 
#  rename(gene = Probe, Strand = 'Probe Strand', Ecto = #Ectoderm_counts, Endo = Endoderm_counts, Meso = 'Mesoderm counts') -> main_raw
#main_raw
  
```
- read Chasity adjusted (based on OPSB, Irina) unique set


```{r}
param5="Chastity adj unique"
source("readCh_adj_Dif_Sim_other.R")
readCh_adj_Dif_Sim_other()->gcha

```


#- read Dif Christels unique sets, high

```{r}
#-------------------New Diff Genes: separate Ect 
#param5='Ch new unique DEGs, high'

#print(param5)

```
- define in one go from read files

```{r}
dect=gcha[[1]]
dect
dend=gcha[[2]]
dend
dmes=gcha[[3]]
dmes
sim=gcha[[4]]
sim


```


- extract DEG vectors from DEGs SEGs
  
```{r}
#----------------submit  DEGs, extract dEG vectors


dect %>% 
  distinct(gene) %>% 
  as_vector() -> DEct_vector
#DEct_vector
len_Dec <- length(DEct_vector)
len_Dec

dend %>% 
  distinct(gene) %>% 
  as_vector() -> DEnd_vector
#DEnd_vector
len_Den <- length(DEnd_vector)
len_Den


dmes %>% 
  distinct(gene) %>% 
  as_vector() -> DMes_vector

len_Dm <- length(DMes_vector)
len_Dm

#------------------Sim
sim %>% 
  distinct(gene) %>% 
  as_vector() -> Sim_vector

len_Ds <- length(Sim_vector)
len_Ds


```
- collect expression for DEG sets from main_raw data

```{r}

main_raw %>%
    mutate(set=case_when(gene %in% DEct_vector ~"DifEc",
                         gene %in% DEnd_vector ~"DifEn",
                         gene %in% DMes_vector ~"DifM",
                         gene %in% Sim_vector ~"Sim")
    )->separated_DS

separated_DS


```

- split due to set
```{r}

  sett<-separated_DS %>%
group_by(set)

group_split(sett)->ss
ss

#--------------------------------

DifEct_NPSB <-ss[[1]]
DifEct_NPSB %>%
    rename(chr=Chromosome,start=Start,end=End,ecto=Ecto, endo=Endo,meso=Meso)->DifEct_NPSB

DifEnd_NPSB <-ss[[2]]
DifEnd_NPSB %>%
    rename(chr=Chromosome,start=Start,end=End,ecto=Ecto, endo=Endo,meso=Meso)->DifEnd_NPSB


DifMes_NPSB <-ss[[3]]

DifMes_NPSB%>%
  rename(chr=Chromosome,start=Start,end=End,ecto=Ecto, endo=Endo,meso=Meso)->DifMes_NPSB


Sim_NPSB <- ss[[4]]
Sim_NPSB%>%
    rename(chr=Chromosome,start=Start,end=End,ecto=Ecto, endo=Endo,meso=Meso)->Sim_NPSB

Comm_notCha <-ss[[5]]
Comm_notCha%>%
    rename(chr=Chromosome,start=Start,end=End,ecto=Ecto, endo=Endo,meso=Meso)->Comm_notCha_NPSB

```
- Mtalab format
```{r}
DifEct_NPSB%>%
  select(gene,chr,start,end,ecto,endo,meso)->Mtlb_NPSB_ect_Cha
DifEnd_NPSB%>%
  select(gene,chr,start,end,ecto,endo,meso)->Mtlb_NPSB_end_Cha
DifMes_NPSB%>%
  select(gene,chr,start,end,ecto,endo,meso)->Mtlb_NPSB_mes_Cha
 Sim_NPSB%>%
  select(gene,chr,start,end,ecto,endo,meso)->Mtlb_NPSB_mes_Cha
     

```



visualise new

```{r}
source("density_DifEct.R")
pec<-density_DifEct(DifEct_Ch)
pec 
#+ facet_wrap( ~ dif)

source("density_DifEnd.R")
pen<-density_DifEnd(DifEnd_Ch, param2)
pen

source("density_DifMes.R")
pm<-density_DifMes(DifMes_Ch)
pm

source("density_Sim.R")
ps<-density_Sim(Sim_new)
ps

p <- ggarrange(pen,pec,pm,ps,ncol=1, common.legend = TRUE)
p
#p + annotate(geom = "text", x = 0, y =0.15, label = paste(param2)) #+ylim(0,1.5)
  

```
- get Matlab format
```{r}


Mtlb_NPSB_ect %>%
  write_tsv("Mtlb_NPSB_ect.txt")

Mtlb_NPSB_end %>%
  write_tsv("Mtlb_NPSB_end.txt")

Mtlb_NPSB_mes %>%
  write_tsv("Mtlb_NPSB_mes.txt")

```


- write DEG_high sets (and Com_notHigh )
```{r}
DifEct_Ch %>%
  write_tsv("DifEct_high.txt")

DifEnd_Ch %>%
  write_tsv("DifEnd_high.txt")

DifMes_Ch %>%
  write_tsv("DifMes_high.txt")

Comm_notH %>%
  write_tsv("Comm_notHigh.txt")

Sim_new %>%
  write_tsv("Sim_newPSB.txt")

```
- intersect old new Sim values (genes were obtained from Chr2018 main raw set)
```{r}
Sim_new %>%
  inner_join(Sim_Ir, by = "gene")->ijSim
ijSim

```

-- correlate correspondent values of layers for Sim sets

```{r}

cor(ijSim$ecto.x, ijSim$ecto.y)->RectS
#RectS

cor(ijSim$endo.x, ijSim$endo.y)->RendS
#RendS

cor(ijSim$meso.x, ijSim$meso.y)->RmesS
#RmesS

Rs=c(RectS,RectS,RectS)

print("Sim from old PBS: corr coeff Sim GE values old vs new PBS=",Rs)
print(Rs)

```



